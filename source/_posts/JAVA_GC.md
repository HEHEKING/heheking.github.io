---
title: JAVA 的 GC 机制（一）
date: 2020/12/2 14:58:11
categories:
- 笔记
tags:
- java
- jvm
- gc
---

Java GC（Garbage Collection，垃圾收集，垃圾回收）机制，是Java与C++/C的主要区别之一。作为Java开发者，一般不需要专门编写内存回收和垃圾清理代码，对内存泄露和溢出的问题，也不需要像C程序员那样战战兢兢。这是因为在Java虚拟机中，存在自动内存管理和垃圾清扫机制。概括地说，该机制对JVM（Java Virtual Machine）中的内存进行标记，并确定哪些内存需要回收，根据一定的回收策略，自动的回收内存，永不停息（Nerver Stop）的保证JVM中的内存空间，防止出现内存泄露和溢出问题。
<!-- more -->
## 一、架构

JVM 采用 HotSpot 架构。支持较强的基本特征和功能，此外还支持高性能和高吞吐率的特性。经过对运行时环境和多线程垃圾回收器不断地设计和优化，现在的HotSpot JVM甚至在大型的系统上都具有较高的伸缩性。

JVM 的主要组件包括：ClassLoader、运行时数据区和执行引擎。

这个架构可以分成三层看：

- 最上层：javac编译器将编译好的字节码class文件，通过java 类装载器执行机制，把对象或class文件存放在 jvm划分内存区域
- 中间层：称为Runtime Data Area，主要是在Java代码运行时用于存放数据的，从左至右为方法区(持久代也叫非堆)、堆(共享,GC回收对象区域)、栈、程序计数器和寄存器、本地栈(私有)
- 最下层：JVM最核心两块 JIT(just in time) 即时编译器 和 **GC（Garbage Collection，垃圾回收器）**

性能优化只需要关注这三个组件即可。堆是存储对象的地方，该区域由用户指定（可以在启动应用程序的时候指定）的垃圾回收器来管理。**大多数优化选项都是通过配置堆的大小和选择最合适的垃圾回收器来实现。**JIT编译器对性能也能产生比较大的影响，但是对于更新版本的 JVM 很少需要对其进行优化。

通常来说，当优化一个Java应用的时候，我们通常重点关心的是响应时间或吞吐量两者其中的一个。

## 二、GC 的工作原理

在了解 GC 之前，需要先了解：**Java 堆内存分为新生代和老年代，新生代中又分为1个 Eden 区域 和 2个 Survivor 区域。**

### **工作区域**

在 JVM 中，程序计数器、虚拟机栈、本地方法栈都是随线程而生随线程而灭，栈帧随着方法的进入和退出做入栈和出栈操作，实现了自动的内存清理，因此，我们的内存垃圾回收主要集中于 java 堆和方法区中，在程序运行期间，这部分内存的分配和使用都是**动态**的。

### **工作对象**

需要进行回收的对象就是已经没有存活的对象，判断一个对象是否存活常用的有两种办法：**引用计数**和可达分析。

(1) 引用计数：每个对象有一个引用计数属性，新增一个引用时计数加1，引用释放时计数减1，计数为0时可以回收。此方法简单，无法解决对象相互循环引用的问题。

(2) 可达性分析（Reachability Analysis）：从GC Roots开始向下搜索，搜索所走过的路径称为引用链。当一个对象到GC Roots没有任何引用链相连时，则证明此对象是不可用的。不可达对象。

> **GC Roots**：
>
> 虚拟机栈中引用的对象。
>
> 方法区中类静态属性实体引用的对象。
>
> 方法区中常量引用的对象。
>
> 本地方法栈中JNI引用的对象。

### **触发时机**

(1) 程序调用System.gc时可以触发

(2) 系统自身来决定GC触发的时机（根据Eden区和From Space区的内存大小来决定。当内存大小不足时，则会启动GC线程并停止应用线程）

> GC 又分为 Minor GC 和 Full GC (也称为 Major GC )
>
> **Minor GC（新生代GC）触发条件：**
>
> 当Eden区满时，触发Minor GC。
>
> 这是发生在新生代的垃圾收集动作，所有的Minor GC都会触发全世界的暂停（stop-the-world），停止应用程序的线程，不过这个过程非常短暂。
>
> **Full GC（老年代GC）触发条件：**
>
> 1. 调用System.gc时，系统建议执行Full GC，但是不必然执行
>
> 2. 老年代空间不足
>
> 3. 方法去空间不足
>
> 4. 通过Minor GC后进入老年代的平均大小大于老年代的可用内存
>
> 5. 由Eden区、From Space区向To Space区复制时，对象大小大于To Space可用内存，则把该对象转存到老年代，且老年代的可用内存小于该对象大小

## 整理来源

https://blog.csdn.net/laomo_bible/article/details/83112622

https://www.cnblogs.com/shudonghe/p/3457990.html

https://www.jianshu.com/p/43d403b3eff7